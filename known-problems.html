<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html">
    <META HTTP-EQUIV="Content-Style-Type" CONTENT="text/css">
    <META HTTP-EQUIV="Resource-type" CONTENT="document"> 
    <META HTTP-EQUIV="Description" CONTENT="Modula-3 Resource Page"> 
    <META HTTP-EQUIV="Distribution" CONTENT="global"> 
    <META HTTP-EQUIV="Keywords" CONTENT="m3, modula-3, modula3, M3, Modula-3, modula-3, cm3, CM3, FreeCM3">
    <META HTTP-EQUIV="Reply-to" CONTENT="webmaster@m3.org"> 
    <LINK HREF="../style/normal.css" REL="stylesheet" TYPE="text/css">
    <title>Known Problems with CM3 5.1</title>
  </head>

  <body bgcolor="#ffffff">
    <h2>Known Problems with CM3 5.1</h2>

    <p>
      Contents:<br><br>

      <a href="#p_1">1 General Problems</a><br>
      &nbsp;&nbsp;    
      <a href="#p_1_1">1.1 Linkage failure: cannot find -lXaw</a><br>
      &nbsp;&nbsp;    
      <a href="#p_1_2">1.2 Filenames with spaces</a><br>
      &nbsp;&nbsp;    
      <a href="#p_1_3">1.3 Linker trouble with latest Microsoft VC++
        compilers on WIN32 platform</a><br>
      &nbsp;&nbsp;    
      <a href="#p_1_4">1.4 Assembler problem on LINUXLIBC6 (filds 
        instrcution)</a><br>
      <br>
      <a href="#p_2">2 Release 5.1.0</a><br>
      &nbsp;&nbsp;    
      <a href="#p_2_1">2.1 Installation on NT386 fails because of
        missing cygwin.dll</a><br>
      <br>
      <a href="#p_3">3 Release 5.1.1</a><br>
      <br>
      <a href="#p_4">4 Release 5.1.2-5.1.8</a><br>
      &nbsp;&nbsp;    
      <a href="#p_4_1">4.1 Linkage failure: missing -L before library
      paths (installer bug)</a><br>
      &nbsp;&nbsp;    
      <a href="#p_4_2">4.2 [Release 5.1.8] Linkage failure on POSIX
        platforms due to wrong paths (/pub/lang/m3/cm3-dist) in binary
        installation archives
      </a><br>
      &nbsp;&nbsp;    
    </p>

    <a name="p_1">
    <h3>1 General Problems</h3>
    </a>

    <p>
      General problems and notes applying to all releases:
    </p>

    <a name="p_1_1">
    <h4>1.1 Linkage failure: cannot find -lXaw</h4>
    </a>

    <p>
      <b>Platforms:</b> mostly LINUXLIBC6, LINUXELF
    </p>

    <p>
      <b>Description:</b>
      Problems of this kind will arise if the linker cannot find the
      static standard libraries of the X systems. This will mostly be
      a problem on Linux systems, as almost all newer distributions
      tend to not install static libraries by default. A typical
      failure situation looks like this:
    </p>

    <pre>
&gt; === package /home/i8fs1/VERIF/usr/old/stow/cm3/current/m3-ui/formsedit ===
&gt;  +++ cm3 -build -override -DROOT=/home/i8fs1/VERIF/usr/old/stow/cm3/current  +++
&gt; --- building in LINUXLIBC6 ---
&gt; /home/i8fs1/VERIF/usr/old/stow/cm3/tmp/bin/m3bundle -name formseditBundle -F/tmp/qk
&gt; new source -&gt; compiling FormsEditVBT.i3
&gt; new source -&gt; compiling formseditBundle.i3
&gt; new source -&gt; compiling FormsEditVBT.m3
&gt; new source -&gt; compiling FormsEdit.m3
&gt; new source -&gt; compiling formseditBundle.m3
&gt;  -&gt; linking formsedit
&gt; /home/i8fs1/VERIF/usr/old/bin/ld: cannot find -lXaw
&gt; collect2: ld returned 1 exit status
    </pre>

    <p>
      <b>Solution:</b>
      Usually it is possible to install the missing libraries without
      much effort.
    </p>

    <a name="p_1_2">
    <h4>1.2 Filenames with spaces</h4>
    </a>

    <p>
      <b>Platforms:</b> all, especially WIN32
    </p>

    <p>
      <b>Description:</b>
      CM3 currently cannot handle filenames containing spaces very
      well. This will probably not be an issue on POSIX platforms, but
      it is very annoying on WIN32, as many standard installation path
      names contain spaces there.
    </p>

    <p>
      The problem cannot be easily resolved. This is due to the broken
      process creation interface on WIN32 platforms, which does not
      allow transparent passing of parameters, and some standard
      <tt>quake</tt> functions, which have to be replaced by more
      general equivalents, like <tt>exec, arglist</tt> (probably more).
    </p>

    <p>
      <b>Solution:</b>
      There is no easy solution to this problem. As a temporary
      workaround, the installer has been modified to replace pathnames
      with spaces by their 8.3 style equivalent on WIN32. If you
      cannot avoid using spaces in your CM3 projects, the 8.3 style
      short form should be a possible though ugly workaround for that,
      too. Voluntary contributions in this area are more than welcome.
      This workaround is incorporated in all installation programs
      since release 5.1.1.
    </p>

    <a name="p_1_3">
    <h4>
      1.3 Linker trouble with latest Microsoft VC++
      compilers on WIN32 platform
    </h4>

    <p>
      <b>Platforms:</b> WIN32/NT386, reproduced with Microsoft 32-Bit
      C/C++-Compiler, Version 12.00.8804, non-issue with 32-bit C/C++
      Standard Compiler Version 10.00.6002 for 80x86 
    </p>

    <p>
      <b>Description:</b>
      Building of dynamic libraries (DLLs) (e.g. for m3core) fails
      with unresolvable ambiguous symbols __real@8@... It turns out
      that during the compilation of C sources the compiler defines an
      8 bytes data section for every floating point constant (which is
      fine) and marks it as exported (which is certainly
      unexpected). The library archiver <tt>mklib</tt> shortens these
      symbols after the first @ character and leaves the linker with
      lots of equally named constants. It is still unclear to me why
      the compiler behaves in this way.
    </p>

    <p>
      <b>Note:</b>
      There has been one report where more linker errors have been
      encountered (in libm3), though the work-around mentioned below
      had been applied. So it may well be that there are still
      undiscovered problems and unknown incompatibilities with
      particular releases of the Microsoft tools.
    </p>

    <p>
      <b>Solution:</b>
      No real solution is known, as I haven't found a way to make the
      compiler not export the floating point constants. Older
      compilers (see above) do not exhibit this
      behaviour. Unfortunately, it is neither possible (as has been
      suggested) to (a) not to shorten the symbols after the @ character,
      and (b) ignore the export of all symbols beginning with two
      underscores while writing the linker .def file (this even fails
      for libm3). In CM3 5.1.3 a workaround has been implemented,
      which cures the problem for all tested m3 packages; this is
      still no general solution, though, as it may break other
      existing code. The <tt>mklib</tt> program has been extended by
      a switch to ignore certain exported symbols: <tt>-ign:XXX</tt>
      instructs the archiver to ignore all symbols beginning with
      XXX. The option <tt>-ign:__real</tt> has been added to the
      templates for the global configuration file <tt>cm3.cfg</tt>.
    </p>

    <a name="p_1_4">
    <h4>
      1.4 Assembler problem on LINUXLIBC6 (filds 
        instrcution)
    </h4>

    <p>
      <b>Platforms:</b> reported for LINUXLIBC6, possibly other POSIX
      platforms, too
    </p>

    <p>
      <b>Description:</b>
      The assembler reports errors due to an unknown i386 instruction
      like this:
      <pre>
  new source -> compiling RealFloatExtras.m3
  RealFloatExtras.ms: Assembler messages:
  RealFloatExtras.ms:69: Error: no such 386 instruction: `filds'
  RealFloatExtras.ms:153: Error: no such 386 instruction: `filds'
  RealFloatExtras.ms:209: Error: no such 386 instruction: `filds'
  new source -> compiling LongFloatExtras.i3
  new source -> compiling LongFloatExtras.m3
  LongFloatExtras.ms: Assembler messages:
  LongFloatExtras.ms:69: Error: no such 386 instruction: `filds'
  LongFloatExtras.ms:154: Error: no such 386 instruction: `filds'
  LongFloatExtras.ms:211: Error: no such 386 instruction: `filds'
      </pre>
      The above was observed on a RedHat 6.1 Linux system with libc6
      and gcc 2.91.66 (egcs-1.1.2). 
    </p>

    <p>
      <b>Solution:</b>
      I've currently no information about the excat version of GNU
      tools that cause the problem, which obviously seems to be a
      compiler/assembler version mismatch. I would expect that
      upgrading the assembler to a more recent version should solve
      the problem, but haven't asserted this yet, nor do can I name
      the version that is needed. More information from people working
      on (RedHat) Linux systems would be welcome.
    </p>

    <a name="p_2">
    <h3>2 Release 5.1.0</h3>
    </a>

    <p>
      Problems and notes specific to release 5.1.0:
    </p>

    <a name="p_2_1">
    <h4>2.1 Installation on NT386 fails because of missing cygwin.dll</h4>
    </a>

    <p>
      <b>Platforms:</b> NT386
    </p>

    <p>
      <b>Description:</b>
      The installation program cannot unpack the system and other
      archives because <tt>cygwin.dll</tt>, which is needed by the
      bundled <tt>tar.exe</tt>, is missing in the installation
      archive. 
    </p>

    <p>
      <b>Solution:</b>
      Either
    </p>
    <ul>
      <li>
        place a working <tt>cygwin.dll</tt> in next to the
        <tt>cminstall</tt> program,
      </li>
      <li>
        place a working <tt>tar.exe</tt> next to the 
        <tt>cminstall</tt> program,
      </li>
      <li>
        get a newer installation archive (5.1.1 or better).
      </li>
    </ul>


    <a name="p_3">
    <h3>3 Release 5.1.1</h3>
    </a>

    <p>
      Problems and notes specific to release 5.1.1:
    </p>

    <a name="p_4">
    <h3>4 Release 5.1.2 - 5.1.8</h3>
    </a>

    <p>
      Problems and notes specific to release 5.1.8:
    </p>

    <a name="p_4_1">
    <h4>
      4.1 Linkage failure: missing -L before library paths (installer bug)
    </h4>
    </a>

    <p>
      <b>Platforms:</b> all
    </p>

    <p>
      <b>Description:</b>
      The compiler complains about non-existant library files when
      trying to link with libraries that were not present at
      installation time but have been installed later. This is due to
      a bug in the installation program <tt>cminstall</tt> which
      forgets to prepend the string "-L" to all library paths for
      libraries that haven't actually been found by it. Thus the
      system library definitions in the configuration file
      <tt>cm3.cfg</tt> used by the system linker are sometimes
      incorrect.
    </p>

    <p>
      <b>Solution:</b>
      Add the missing -L to all system library definitions in
      <tt>cm3.cfg</tt> where it is missing. For example, the
      corresponding section in a FreeBSD4 configuration file (located
      at <tt>/usr/local/cm3/bin/cm3.cfg</tt> by default) might look
      like this (with all library path options added):
    </p>
    <pre>
SYSTEM_LIBS = {
  "LIBC"       : [ "-lm" ],
  "LEX-YACC"   : [ "-L/usr/lib", "-ll" ],
% "FLEX-BISON" : [ "-L/usr/lib", "-lfl" ],
  "POSTGRES95" : [ "-L/usr/local/pgsql/lib", "-lpq" ],
  "OPENGL"     : [ "-L/usr/X11R6/lib", "-lGLU", "-lGL", "-lXext" ],
  "MOTIF"      : [ "-L/usr/X11R6/lib", "-lXm" ],
  "X11"        : [ "-L/usr/X11R6/lib", "-lXaw", "-lXmu", "-lXext",
                   "-lXt", "-lSM", "-lICE", "-lX11" ],
  "TCP"        : [ ],
  "ODBC"       : [ "-L/usr/local/lib", "-lodbc" ]
}
    </pre>
    <p>
      The problem has been corrected shortly after the release of CM3
      5.1.8.
    </p>

    <a name="p_4_2">
    <h4>
      4.2 [Release 5.1.8] Linkage failure on POSIX platforms due to
          wrong paths (/pub/lang/m3/cm3-dist) in binary installation
          archives
    </h4> 
    </a>

    <p>
      <b>Platforms:</b> all POSIX platforms
    </p>

    <p>
      <b>Description:</b> The isolation of the garbage collection
      support from <tt>m3core</tt> has lead to one unexpected problem
      in the preparation of the minimal binary installation
      archives. On all POSIX platforms, <tt>m3core</tt> now depends on
      either <tt>m3gc-simple</tt> or <tt>m3gc-enhanced</tt>. As
      <tt>m3core</tt> cannot <em>import</em> another Modula-3 library
      (due to subtleties of the runtime implementation), these
      libraries only contain some C source code files and are shipped
      explicitly to the installation root (<tt>INSTALL_ROOT</tt> in
      <tt>cm3.cfg</tt>). The used declaration for this export
      (<tt>LibdExport(libname)</tt>) creates an import directive like
      the following one in all <tt>.M3EXPORTS</tt> files of packages
      depending on it:
    </p>
    <pre>
  _import_otherlib("m3gcdefs", "/pub/lang/m3/cm3-dist/cm3/lib", IMPORTED)
    </pre>
    <p>
      This directive contains the absolute path (<tt>LIB_INSTALL</tt>)
      of the library in question. As the binary installation archives
      are always produced in an empty staging area
      (for example <tt>/pub/lang/m3/cm3-dist/cm3</tt>), this path is
      unlikely to be correct for the actual installation (where it
      should be <tt>/usr/local/cm3/lib</tt> by default).
    </p>

    <p>
      <b>Solution:</b>
      There are several possible solutions for this problem. We assume
      that <tt>INSTALL_ROOT</tt> is <tt>/usr/local/cm3</tt> and
      <tt>TARGET</tt> is the POSIX platform in use (FreeBSD4,
      LINUXLIBC6, etc.).
    </p>
    <ol>
      <li>
        After the installation of the minimal binary cm3 5.1.8
        distribution, edit the files
        <blockquote>
          <tt>/usr/local/cm3/pkg/m3core/TARGET/.M3EXPORTS</tt>
          <tt>/usr/local/cm3/pkg/libm3/TARGET/.M3EXPORTS</tt>
        </blockquote>
        and replace the line
        <blockquote>
          <tt>_import_otherlib("m3gcdefs", "/pub/lang/m3/cm3-dist/cm3/lib", IMPORTED)</tt>
        </blockquote>
        by either
        <blockquote>
          <tt>_import_otherlib("m3gcdefs", "/usr/local/cm3/lib", IMPORTED)</tt>
        </blockquote>
        or
        <blockquote>
          <tt>_import_otherlib("m3gcdefs", LIB_USE, IMPORTED)</tt>
        </blockquote>
      </li>
      <li>
        After the installation of the minimal binary cm3 5.1.8
        distribution, build and ship the packages <tt>m3core</tt> and
        <tt>libm3</tt> from one of the source distribution archives
        (e.g. <tt>cm3-src-std-5.1.8.tgz</tt>). You can do this with
        the following commands (<tt>WORK</tt> identifying your working
        area where you unpacked the sources):
        <pre>
  cd WORK/cm3/scripts
  ./do-pkg buildship m3core
  ./do-pkg buildship libm3
        </pre>
        This will put the correct paths in the <tt>.M3EXPORTS</tt>
        files.
      </li>
      <li>
        Use <tt>sed</tt> or <tt>perl</tt> to perform the needed
        substitutions as described in (1).
      </li>
    </ol>
    <p>
      Future distributions (release &gt; 5.1.8) will avoid this
      problem by either modifying the export/import-mechanism for
      <tt>m3gc-simple</tt> and <tt>m3gc-enhanced</tt>, adjust the
      absolute paths during the construction of the binary
      distribution archive, or automatically adjust the abolsute paths
      after installation.
    </p>

    <!--
    <h4></h4>

    <p>
      <b>Platforms:</b> all
    </p>

    <p>
      <b>Description:</b>
    </p>

    <p>
      <b>Solution:</b>
    </p>
    -->

    <hr>
    <address><a href="mailto:m3-support@elego.de">m3-support@elego.de</a></address>
<!-- Created: Fri Mar  2 10:51:41 MET 2001 -->
<!-- hhmts start -->
Last modified: Tue Feb 12 12:38:43 CET 2002
<!-- hhmts end -->
  </body>
</html>
